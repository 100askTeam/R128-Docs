"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[1188],{6803:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>i,default:()=>o,frontMatter:()=>c,metadata:()=>l,toc:()=>a});var s=t(5893),r=t(1151);const c={},i="\u9a71\u52a8 WS2812 \u6d41\u6c34\u706f",l={id:"demo/part1/chapter6",title:"\u9a71\u52a8 WS2812 \u6d41\u6c34\u706f",description:"| \u672c\u6587\u6848\u4f8b\u4ee3\u7801               | \u4e0b\u8f7d\u5730\u5740                               |",source:"@site/docs/demo/part1/chapter6.md",sourceDirName:"demo/part1",slug:"/demo/part1/chapter6",permalink:"/demo/part1/chapter6",draft:!1,unlisted:!1,editUrl:"https://github.com/100askTeam/R128-Docs/tree/main/docs/demo/part1/chapter6.md",tags:[],version:"current",frontMatter:{},sidebar:"classparttwoSidebar",previous:{title:"\u4e2d\u65ad\u65b9\u5f0f\u9a71\u52a8\u65cb\u8f6c\u7f16\u7801\u5668",permalink:"/demo/part1/chapter5"},next:{title:"\u83b7\u53d6\u771f\u968f\u673a\u6570",permalink:"/demo/part1/chapter7"}},d={},a=[{value:"LEDC \u6a21\u5757\u7b80\u4ecb",id:"ledc-\u6a21\u5757\u7b80\u4ecb",level:2},{value:"\u8bbe\u7f6e LEDC \u9a71\u52a8",id:"\u8bbe\u7f6e-ledc-\u9a71\u52a8",level:2},{value:"\u914d\u7f6e LEDC \u53c2\u6570",id:"\u914d\u7f6e-ledc-\u53c2\u6570",level:2},{value:"\u7f16\u8bd1\u6d4b\u8bd5",id:"\u7f16\u8bd1\u6d4b\u8bd5",level:2},{value:"\u70b9\u4eae\u7ea2\u8272 LED",id:"\u70b9\u4eae\u7ea2\u8272-led",level:3},{value:"\u70b9\u4eae\u7eff\u8272 LED",id:"\u70b9\u4eae\u7eff\u8272-led",level:3},{value:"\u5b9e\u73b0\u4e03\u5f69\u6d41\u6c34\u706f",id:"\u5b9e\u73b0\u4e03\u5f69\u6d41\u6c34\u706f",level:2}];function h(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",img:"img",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,r.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"\u9a71\u52a8-ws2812-\u6d41\u6c34\u706f",children:"\u9a71\u52a8 WS2812 \u6d41\u6c34\u706f"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{style:{textAlign:"left"},children:"\u672c\u6587\u6848\u4f8b\u4ee3\u7801"}),(0,s.jsx)(n.th,{style:{textAlign:"left"},children:"\u4e0b\u8f7d\u5730\u5740"})]})}),(0,s.jsx)(n.tbody,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{style:{textAlign:"left"},children:"\u9a71\u52a8 WS2812 \u6d41\u6c34\u706f\u6848\u4f8b\u4ee3\u7801"}),(0,s.jsx)(n.td,{style:{textAlign:"left"},children:(0,s.jsx)(n.a,{href:"https://www.aw-ol.com/downloads?cat=24",children:"https://www.aw-ol.com/downloads?cat=24"})})]})})]}),"\n",(0,s.jsx)(n.p,{children:"R128-DevKit \u62e5\u67094\u9897 WS2812 LED\uff0c\u672c\u6587\u5c06\u8be6\u7ec6\u53d9\u8ff0\u5982\u4f55\u70b9\u4eae\u4ed6\u4eec\u3002"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"http://photos.100ask.net/aw-r128-docs/rtos/demo/part1/chapter6/image1.png",alt:""})}),"\n",(0,s.jsx)(n.h2,{id:"ledc-\u6a21\u5757\u7b80\u4ecb",children:"LEDC \u6a21\u5757\u7b80\u4ecb"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"http://photos.100ask.net/aw-r128-docs/rtos/demo/part1/chapter6/image2.png",alt:""})}),"\n",(0,s.jsx)(n.p,{children:"LEDC \u786c\u4ef6\u65b9\u6846\u56fe\u5982\u4e0a\u56fe\u6240\u793a\uff0cCPU \u901a\u8fc7 APB \u603b\u7ebf\u64cd\u4f5c LEDC \u5bc4\u5b58\u5668\u6765\u63a7\u5236 LEDC\uff1b\u5f53 CPU\u914d\u7f6e\u597d LEDC \u7684\u76f8\u5173\u5bc4\u5b58\u5668\u4e4b\u540e\uff0c\u901a\u8fc7 CPU \u6216 DMA \u5c06 R\u3001G\u3001B \u6570\u636e\u4ece DRAM \u642c\u5230 LEDC FIFO \u4e2d\uff0c\u542f\u52a8 LEDC \u4e4b\u540e\u5c31\u53ef\u4ee5\u901a\u8fc7 PIN \u811a\u5411\u5916\u90e8\u7684 LED \u53d1\u9001\u6570\u636e\u4e86\u3002"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"http://photos.100ask.net/aw-r128-docs/rtos/demo/part1/chapter6/image3.png",alt:""})}),"\n",(0,s.jsx)(n.p,{children:"LED \u5178\u578b\u7535\u8def\u5982\u56fe\u6240\u793a\uff0c\u5176\u4e2d DI \u8868\u793a\u63a7\u5236\u6570\u636e\u8f93\u5165\u811a\uff0cDO \u8868\u793a\u63a7\u5236\u6570\u636e\u8f93\u51fa\u811a\u3002DI \u7aef\u63a5\u6536\u4ece\u63a7\u5236\u5668\u4f20\u8fc7\u6765\u7684\u6570\u636e\uff0c\u6bcf\u4e2a LED \u5185\u90e8\u7684\u6570\u636e\u9501\u5b58\u5668\u4f1a\u5b58\u50a8 24bit \u6570\u636e\uff0c\u5269\u4f59\u7684\u6570\u636e\u7ecf\u8fc7\u5185\u90e8\u6574\u5f62\u5904\u7406\u7535\u8def\u6574\u5f62\u653e\u5927\u540e\u901a\u8fc7 DO \u7aef\u53e3\u5f00\u59cb\u8f6c\u53d1\u8f93\u51fa\u7ed9\u4e0b\u4e00\u4e2a\u7ea7\u8054\u7684 LED\u3002\u56e0\u6b64\uff0c\u6bcf\u7ecf\u8fc7\u4e00\u4e2aLED\uff0c\u6570\u636e\u51cf\u5c11 24bit\u3002"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"http://photos.100ask.net/aw-r128-docs/rtos/demo/part1/chapter6/image4.png",alt:""})}),"\n",(0,s.jsx)(n.p,{children:"\u6ce8\u610f\uff0c\u5982\u679c\u5728\u5355\u6b21\u76f4\u63a5\u8bbe\u7f6e\u7b2c n \u4e2a LED \u7684\u4eae\u5ea6\u548c\u8272\u5f69\u7684\u65f6\u5019\uff0c\u524d\u9762 n-1 \u4e2a LED \u7684\u4eae\u5ea6\u6570\u636e\u4f1a\u5728\u7b2c n \u4e2a LED \u7684\u6570\u636e\u524d\u53d1\u9001\uff0c\u4e0d\u8fc7\u8fd9\u4e9b\u6570\u636e\u5c06\u4f1a\u662f\u539f\u6765 n-1 \u4e2a LED \u7684\u4eae\u5ea6\u6570\u636e\u3002"}),"\n",(0,s.jsx)(n.p,{children:"\u7531\u4e8e\u62e5\u6709\u72ec\u7acb\u7684 LEDC \u6a21\u5757\uff0c\u5728 R128 \u5e73\u53f0\u4e0a\u9a71\u52a8 WS2812 \u7c7b\u4f3c\u7684 RGB LED \u4e0d\u9700\u8981\u4f7f\u7528 SPI \u6a21\u62df\uff0c\u4e5f\u4e0d\u9700\u8981\u4f7f\u7528 PWM \u914d\u7f6e\u65f6\u5e8f\u3002\u76f4\u63a5\u4f7f\u7528\u8fd9\u4e2a\u6a21\u5757\u5373\u53ef\u3002"}),"\n",(0,s.jsx)(n.h2,{id:"\u8bbe\u7f6e-ledc-\u9a71\u52a8",children:"\u8bbe\u7f6e LEDC \u9a71\u52a8"}),"\n",(0,s.jsxs)(n.p,{children:["\u8fd0\u884c ",(0,s.jsx)(n.code,{children:"mrtos_menuconfig"})," \u8fdb\u5165\u914d\u7f6e\u9875\u9762\u3002\u524d\u5f80\u4e0b\u5217\u5730\u5740\u627e\u5230 ",(0,s.jsx)(n.code,{children:"LEDC Devices"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"Drivers Options  ---\x3e\n    soc related device drivers  ---\x3e\n            LEDC devices ---\x3e\n                [*] enable ledc driver\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u627e\u5230 LEDC Devices"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"http://photos.100ask.net/aw-r128-docs/rtos/demo/part1/chapter6/image5.png",alt:""})}),"\n",(0,s.jsx)(n.p,{children:"\u52fe\u9009\u5982\u4e0b\u9009\u9879"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"http://photos.100ask.net/aw-r128-docs/rtos/demo/part1/chapter6/image6.png",alt:""})}),"\n",(0,s.jsx)(n.h2,{id:"\u914d\u7f6e-ledc-\u53c2\u6570",children:"\u914d\u7f6e LEDC \u53c2\u6570"}),"\n",(0,s.jsxs)(n.p,{children:["\u53c2\u8003\u7535\u8def\u56fe\u53ef\u77e5\uff0cLEDC \u6a21\u5757\u8fde\u63a5\u7684\u662f R128 \u7684 ",(0,s.jsx)(n.code,{children:"PA13"})," \u5f15\u811a\u3002\u53c2\u8003\u624b\u518c\u53ef\u77e5 MUX \u4e3a 7"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"http://photos.100ask.net/aw-r128-docs/rtos/demo/part1/chapter6/image7.png",alt:""})}),"\n",(0,s.jsxs)(n.p,{children:["\u524d\u5f80 ",(0,s.jsx)(n.code,{children:"lichee/rtos/drivers/rtos-hal/hal/source/ledc/platform/ledc_sun20iw2.h"})," \u5e76\u7f16\u8f91 LEDC \u7684\u5f15\u811a\u548cMUX"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-c",children:"#define LEDC_PIN    GPIOA(13)\n#define LEDC_PINMUXSEL  7\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"http://photos.100ask.net/aw-r128-docs/rtos/demo/part1/chapter6/image8.png",alt:""})}),"\n",(0,s.jsxs)(n.p,{children:["\u7136\u540e\u7f16\u8f91 ",(0,s.jsx)(n.code,{children:"lichee/rtos/drivers/rtos-hal/hal/source/ledc/hal_ledc.c"})," \u914d\u7f6e WS2812 \u7684\u65f6\u5e8f\u53c2\u6570\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-c",children:'struct ledc_config ledc_config = {\n    .led_count = 4,\n    .reset_ns = 84,\n    .t1h_ns = 1000,\n    .t1l_ns = 1000,\n    .t0h_ns = 580,\n    .t0l_ns = 1000,\n    .wait_time0_ns = 84,\n    .wait_time1_ns = 84,\n    .wait_data_time_ns = 600000,\n    .output_mode = "GRB",\n};\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"http://photos.100ask.net/aw-r128-docs/rtos/demo/part1/chapter6/image9.png",alt:""})}),"\n",(0,s.jsx)(n.h2,{id:"\u7f16\u8bd1\u6d4b\u8bd5",children:"\u7f16\u8bd1\u6d4b\u8bd5"}),"\n",(0,s.jsx)(n.p,{children:"\u7f16\u8bd1\u540e\u70e7\u5f55\u5f00\u53d1\u677f"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"http://photos.100ask.net/aw-r128-docs/rtos/demo/part1/chapter6/image10.png",alt:""})}),"\n",(0,s.jsxs)(n.p,{children:["\u53ef\u4ee5\u7528\u547d\u4ee4 ",(0,s.jsx)(n.code,{children:"hal_ledc"})," \u6765\u6d4b\u8bd5"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"hal_ledc <LED\u53f7> <R|G|B> <\u4eae\u5ea6>\n"})}),"\n",(0,s.jsx)(n.h3,{id:"\u70b9\u4eae\u7ea2\u8272-led",children:"\u70b9\u4eae\u7ea2\u8272 LED"}),"\n",(0,s.jsx)(n.p,{children:"\u8fd0\u884c\u547d\u4ee4"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"hal_ledc 1 R 100\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"http://photos.100ask.net/aw-r128-docs/rtos/demo/part1/chapter6/image11.png",alt:""})}),"\n",(0,s.jsx)(n.p,{children:"\u5373\u53ef\u70b9\u4eae\u7b2c\u4e00\u9897 LED"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"http://photos.100ask.net/aw-r128-docs/rtos/demo/part1/chapter6/image12.png",alt:""})}),"\n",(0,s.jsx)(n.h3,{id:"\u70b9\u4eae\u7eff\u8272-led",children:"\u70b9\u4eae\u7eff\u8272 LED"}),"\n",(0,s.jsx)(n.p,{children:"\u8fd0\u884c\u547d\u4ee4"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"hal_ledc 2 G 100\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"http://photos.100ask.net/aw-r128-docs/rtos/demo/part1/chapter6/image13.png",alt:""})}),"\n",(0,s.jsx)(n.p,{children:"\u7b2c\u4e8c\u9897 LED \u5373\u53ef\u70b9\u4eae\u7eff\u8272"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"http://photos.100ask.net/aw-r128-docs/rtos/demo/part1/chapter6/image14.png",alt:""})}),"\n",(0,s.jsx)(n.h2,{id:"\u5b9e\u73b0\u4e03\u5f69\u6d41\u6c34\u706f",children:"\u5b9e\u73b0\u4e03\u5f69\u6d41\u6c34\u706f"}),"\n",(0,s.jsxs)(n.p,{children:["\u524d\u5f80\u9879\u76ee\u6587\u4ef6\u5939\u7f16\u8f91 ",(0,s.jsx)(n.code,{children:"main.c"}),"\uff0c\u8fd9\u91cc\u6211\u9009\u62e9\u5728 M33 \u6838\u5fc3\u4e0a\u7f16\u5199\u7a0b\u5e8f\uff0c\u6240\u4ee5\u9009\u7528\u7684\u662f ",(0,s.jsx)(n.code,{children:"lichee/rtos/projects/r128s2/module_m33/src/main.c"})," \uff0c\u5982\u679c\u662f\u7f16\u5199 C906 \u6838\u5fc3\u7684\u7a0b\u5e8f\uff0c\u8bf7\u4fee\u6539 ",(0,s.jsx)(n.code,{children:"lichee/rtos/projects/r128s2/module_c906/src/main.c"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-c",children:'#include <sunxi_hal_ledc.h>\n#include <hal_cmd.h>\n#include <hal_timer.h>\n\n// \u4f7f\u7528RGB \u5206\u91cf\u5408\u6210\u989c\u8272\u503c\n#define MERAGECOLOR(G, R, B) (((uint32_t)G << 16) | ((uint16_t)R << 8) | B)\n#define PIXEL_NUM 4\n\n// \u751f\u6210\u989c\u8272\nuint32_t WS281x_Wheel(uint8_t wheelPos) {\n  wheelPos = 255 - wheelPos;\n  if (wheelPos < 85) {\n    return MERAGECOLOR(255 - wheelPos * 3, 0, wheelPos * 3);\n  }\n  if (wheelPos < 170) {\n    wheelPos -= 85;\n    return MERAGECOLOR(0, wheelPos * 3, 255 - wheelPos * 3);\n  }\n  wheelPos -= 170;\n  return MERAGECOLOR(wheelPos * 3, 255 - wheelPos * 3, 0);\n}\n\n// \u4eae\u5ea6\u8bbe\u7f6e\nuint32_t WS281xLSet(uint32_t rgb, float k) {\n    uint8_t r, g, b;\n    float h, s, v;\n    uint8_t cmax, cmin, cdes;\n\n    r = (uint8_t) (rgb >> 16);\n    g = (uint8_t) (rgb >> 8);\n    b = (uint8_t) (rgb);\n\n    cmax = r > g ? r : g;\n    if (b > cmax)\n        cmax = b;\n    cmin = r < g ? r : g;\n    if (b < cmin)\n        cmin = b;\n    cdes = cmax - cmin;\n\n    v = cmax / 255.0f;\n    s = cmax == 0 ? 0 : cdes / (float) cmax;\n    h = 0;\n\n    if (cmax == r && g >= b)\n        h = ((g - b) * 60.0f / cdes) + 0;\n    else if (cmax == r && g < b)\n        h = ((g - b) * 60.0f / cdes) + 360;\n    else if (cmax == g)\n        h = ((b - r) * 60.0f / cdes) + 120;\n    else\n        h = ((r - g) * 60.0f / cdes) + 240;\n\n    v *= k;\n\n    float f, p, q, t;\n    float rf, gf, bf;\n    int i = ((int) (h / 60) % 6);\n    f = (h / 60) - i;\n    p = v * (1 - s);\n    q = v * (1 - f * s);\n    t = v * (1 - (1 - f) * s);\n    switch (i) {\n    case 0:\n        rf = v;\n        gf = t;\n        bf = p;\n        break;\n    case 1:\n        rf = q;\n        gf = v;\n        bf = p;\n        break;\n    case 2:\n        rf = p;\n        gf = v;\n        bf = t;\n        break;\n    case 3:\n        rf = p;\n        gf = q;\n        bf = v;\n        break;\n    case 4:\n        rf = t;\n        gf = p;\n        bf = v;\n        break;\n    case 5:\n        rf = v;\n        gf = p;\n        bf = q;\n        break;\n    default:\n        break;\n    }\n\n    r = (uint8_t) (rf * 255.0);\n    g = (uint8_t) (gf * 255.0);\n    b = (uint8_t) (bf * 255.0);\n\n    return ((uint32_t) r << 16) | ((uint32_t) g << 8) | b;\n}\n\n// \u5ef6\u65f6\u51fd\u6570\nstatic inline int msleep(int ms) {\n    vTaskDelay(ms / portTICK_RATE_MS); \n}\n\n// \u6d4b\u8bd5 LEDC\nint ledc_test_loop() {\n  int i = 0, j = 0, err;\n  int mode = 0;\n  uint8_t R = 0, G = 0, B = 0;\n\n  err = hal_ledc_init();\n  if (err) {\n    printf("ledc init error\\n");\n    return -1;\n  }\n\n  while (1) {\n    for (j = 0; j < 256; j++) {\n      for (i = 0; i < PIXEL_NUM; i++) {\n        sunxi_set_led_brightness(\n            i + 1, WS281xLSet(WS281x_Wheel(((i * 256 / PIXEL_NUM) + j) & 255), 0.2));\n        msleep(1);\n      }\n      msleep(10);\n    }\n  }\n  return 1;\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["\u5e76\u4e14\u5c06\u6d4b\u8bd5\u51fd\u6570\u52a0\u5165\u5230 ",(0,s.jsx)(n.code,{children:"cpu0_app_entry"})," \u4e2d\u3002"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"http://photos.100ask.net/aw-r128-docs/rtos/demo/part1/chapter6/image15.png",alt:""})}),"\n",(0,s.jsx)(n.p,{children:"\u91cd\u65b0\u70e7\u5f55\u5373\u53ef\u5b9e\u73b0\u4e03\u5f69\u6d41\u6c34\u706f"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"http://photos.100ask.net/aw-r128-docs/rtos/demo/part1/chapter6/image16.png",alt:""})})]})}function o(e={}){const{wrapper:n}={...(0,r.a)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},1151:(e,n,t)=>{t.d(n,{Z:()=>l,a:()=>i});var s=t(7294);const r={},c=s.createContext(r);function i(e){const n=s.useContext(c);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),s.createElement(c.Provider,{value:n},e.children)}}}]);